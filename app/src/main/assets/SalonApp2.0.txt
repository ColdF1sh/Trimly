DROP TABLE IF EXISTS Appointments;
DROP TABLE IF EXISTS Reviews;
DROP TABLE IF EXISTS MasterSessions;
DROP TABLE IF EXISTS Services;
DROP TABLE IF EXISTS EstablishmentMasters;
DROP TABLE IF EXISTS EstablishmentAdmins;
DROP TABLE IF EXISTS Establishments;
DROP TABLE IF EXISTS Users;
-- DROP TABLE IF EXISTS master_schedule; -- Видаляємо master_schedule, оскільки MasterSessions виконує схожу функцію

-- Створюємо таблицю Користувачів (Users)
CREATE TABLE Users (
    userid INTEGER PRIMARY KEY AUTOINCREMENT,
    first_name TEXT NOT NULL,
    last_name TEXT,
    email TEXT UNIQUE NOT NULL,
    phone TEXT UNIQUE NOT NULL,
    role TEXT NOT NULL DEFAULT 'client',
    rating REAL DEFAULT 5.0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    CHECK (role IN ('client', 'master', 'admin'))
);

-- Створюємо таблицю Закладів (Establishments)
CREATE TABLE Establishments (
    establishmentid INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    address TEXT NOT NULL,
    latitude REAL NOT NULL,
    longitude REAL NOT NULL,
    phone_number TEXT,
    website TEXT,
    description TEXT,
    rating REAL DEFAULT 5.0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Створюємо таблицю майстрів закладу (EstablishmentMasters)
CREATE TABLE EstablishmentMasters (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    userid INTEGER NOT NULL,
    establishmentid INTEGER NOT NULL,
    specialization TEXT,
    portfolio_url TEXT,
    rating REAL DEFAULT 5.0,
    FOREIGN KEY (userid) REFERENCES Users(userid) ON DELETE CASCADE,
    FOREIGN KEY (establishmentid) REFERENCES Establishments(establishmentid) ON DELETE CASCADE
);

-- Створюємо таблицю послуг (Services)
CREATE TABLE Services (
    serviceid INTEGER PRIMARY KEY AUTOINCREMENT,
    establishmentid INTEGER NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    price REAL NOT NULL,
    duration INTEGER NOT NULL,
    FOREIGN KEY (establishmentid) REFERENCES Establishments(establishmentid) ON DELETE CASCADE
);

-- Створюємо таблицю сесій майстрів (MasterSessions)
CREATE TABLE MasterSessions (
    sessionid INTEGER PRIMARY KEY AUTOINCREMENT,
    masterid INTEGER NOT NULL,
    establishmentid INTEGER NOT NULL,
    date TEXT NOT NULL,
    start_time TEXT NOT NULL,
    end_time TEXT NOT NULL,
    status TEXT DEFAULT 'PENDING',
    CHECK (status IN ('PENDING', 'CONFIRMED', 'CANCELLED', 'COMPLETED')),
    FOREIGN KEY (masterid) REFERENCES Users(userid) ON DELETE CASCADE,
    FOREIGN KEY (establishmentid) REFERENCES Establishments(establishmentid) ON DELETE CASCADE
);

-- Створюємо таблицю записів (Appointments)
CREATE TABLE Appointments (
    appointmentid INTEGER PRIMARY KEY AUTOINCREMENT,
    clientid INTEGER NOT NULL,
    sessionid INTEGER NOT NULL,
    serviceid INTEGER NOT NULL,
    establishmentid INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (clientid) REFERENCES Users(userid) ON DELETE CASCADE,
    FOREIGN KEY (sessionid) REFERENCES MasterSessions(sessionid) ON DELETE CASCADE,
    FOREIGN KEY (serviceid) REFERENCES Services(serviceid) ON DELETE CASCADE,
    FOREIGN KEY (establishmentid) REFERENCES Establishments(establishmentid) ON DELETE CASCADE
);

-- Створюємо таблицю відгуків (Reviews)
CREATE TABLE Reviews (
    reviewid INTEGER PRIMARY KEY AUTOINCREMENT,
    clientid INTEGER NOT NULL,
    establishmentid INTEGER,
    masterid INTEGER,
    rating INTEGER CHECK (rating BETWEEN 1 AND 5),
    comment TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (clientid) REFERENCES Users(userid) ON DELETE CASCADE,
    FOREIGN KEY (establishmentid) REFERENCES Establishments(establishmentid) ON DELETE SET NULL,
    FOREIGN KEY (masterid) REFERENCES Users(userid) ON DELETE SET NULL
);

-- Додаємо тестові дані
INSERT INTO Users (first_name, last_name, email, phone, role) VALUES
('Іван', 'Петренко', 'ivan.petrenko@example.com', '+380501112233', 'client'),
('Олена', 'Коваленко', 'olena.kovalenko@example.com', '+380674445566', 'client'),
('Сергій', 'Сидоренко', 'sergiy.sydorenko@example.com', '+380637778899', 'client'),
('Олег', 'Бойко', 'oleg.boyko@example.com', '+380501234567', 'master'),
('Андрій', 'Мельник', 'andriy.melnyk@example.com', '+380502345678', 'master'),
('Марія', 'Шевченко', 'maria.shevchenko@example.com', '+380503456789', 'master'),
('Оксана', 'Кравченко', 'oksana.kravchenko@example.com', '+380504567890', 'master');

-- Майстри закладів
INSERT INTO EstablishmentMasters (userid, establishmentid, specialization, portfolio_url, rating) VALUES
(4, 1, 'Чоловічі стрижки', 'http://portfolio.barberking.ua/oleg', 4.9),
(5, 1, 'Гоління', NULL, 4.7),
(6, 2, 'Жіночі стрижки', 'http://portfolio.lileya.ua/maria', 4.8),
(7, 2, 'Фарбування', NULL, 4.6);

-- Заклади
INSERT INTO Establishments (name, address, latitude, longitude, phone_number, website, description, rating) VALUES
('Barber King', 'вул. Соборна, 15', 49.842957, 24.031111, '+380322223344', 'http://barberking.ua', 'Кращий барбершоп у місті.', 4.8),
('Beauty Salon Lileya', 'пр. Свободи, 20', 49.840000, 24.025000, '+380325556677', 'http://lileya.com.ua', 'Салон краси для жінок та чоловіків.', 4.5);

-- Послуги
INSERT INTO Services (establishmentid, name, description, price, duration) VALUES
(1, 'Чоловіча стрижка', 'Модельна стрижка для чоловіків', 300.00, 45),
(1, 'Гоління бороди', 'Класичне гоління небезпечною бритвою', 200.00, 30),
(2, 'Жіноча стрижка', 'Модельна стрижка для жінок', 400.00, 60),
(2, 'Фарбування волосся (в 1 тон)', 'Фарбування волосся в один колір', 800.00, 90),
(2, 'Класичний манікюр', 'Обрізний або європейський манікюр', 250.00, 40);

-- Сесії Майстрів (MasterSessions)
INSERT INTO MasterSessions (masterid, establishmentid, date, start_time, end_time, status) VALUES
(4, 1, '2024-12-01', '10:00', '10:45', 'PENDING'),
(4, 1, '2024-12-01', '11:00', '11:45', 'PENDING'),
(4, 1, '2024-12-01', '12:00', '12:30', 'CONFIRMED'),
(5, 1, '2024-12-01', '10:00', '10:30', 'PENDING'),
(6, 2, '2024-12-01', '14:00', '15:00', 'PENDING'),
(6, 2, '2024-11-28', '11:00', '12:00', 'COMPLETED'),
(7, 2, '2024-12-02', '09:00', '09:40', 'PENDING');

-- Записи (Appointments)
INSERT INTO Appointments (clientid, sessionid, serviceid, establishmentid) VALUES
(1, 3, 1, 1),
(2, 6, 3, 2);

-- Відгуки
INSERT INTO Reviews (clientid, establishmentid, masterid, rating, comment) VALUES
(2, 2, 6, 5, 'Дуже сподобалася стрижка у Марії!'),
(1, 1, NULL, 4, 'Хороший барбершоп, привітний персонал!');